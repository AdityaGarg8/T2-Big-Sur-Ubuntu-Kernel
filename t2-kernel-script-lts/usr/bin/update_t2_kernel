#!/bin/bash
#upgrading script apple linux T2 Kernel

if [ $USER != root ]
then
sudo chmod 755 $0
sudo $0 $1
exit 0
fi

set -e

cd /tmp

use_lts=true
lts_version=5.15

if [[ $use_lts != true ]]
then
latest=$(curl -sL https://github.com/t2linux/T2-Ubuntu-Kernel/releases/latest/ | grep "<title>Release" | awk -F " " '{print $2}' )
else
getkernelver=$(curl -sL https://github.com/t2linux/T2-Ubuntu-Kernel/releases | grep "{{ urlEncodedRefName }}" | grep -v "generic" | grep v${lts_version} | cut -d "{" -f 3 | cut -c 25- | head -1)
latest=${getkernelver::-76}
fi

if [[ (${#latest} = 6) || (${#latest} = 7) ]]
then
latestkver=$(echo $latest | cut -d "v" -f 2 | cut -d "-" -f 1 | awk '{print $1".0-1"}')
latestk=$(echo $latest | cut -c 2- | cut -d "-" -f 1 | awk '{print $1".0-t2"}')-$(lsb_release -c | cut -d ":" -f 2 | xargs)
else
latestkver=$(echo $latest | cut -d "v" -f 2)
latestk=$(echo $latest | cut -c 2- | cut -d "-" -f 1 | awk '{print $1"-t2"}')-$(lsb_release -c | cut -d ":" -f 2 | xargs)
fi

currentk=$(uname -r)
currentk_external=$(echo "${currentk}" | cut -d "-" -f 2,3)
existingK=($(dpkg --list | grep linux-image- | grep 't2\|mbp' | cut -d ' ' -f 2-3 ))
if [ \( $latestk != $currentk \) ]; then
	
	echo "Downloading new kernel $latest"
	echo -e "\nDownloading linux-headers-${latestk}"
	echo
	curl -#L https://github.com/t2linux/T2-Ubuntu-Kernel/releases/download/${latest}/linux-headers-${latestk}_${latestkver}_amd64.deb > headers.deb
	echo -e "\nDownloading linux-image-${latestk}"
	echo
	curl -#L https://github.com/t2linux/T2-Ubuntu-Kernel/releases/download/${latest}/linux-image-${latestk}_${latestkver}_amd64.deb > image.deb

	if [ -f headers.deb -a -f image.deb ]; then
		#install
		echo -e "\nInstalling new kernel $latest"
		echo
		apt install ./headers.deb
		echo
		apt install ./image.deb
		#shutdown -r 02:00 "reboot scheduled for the next 2am to update runnning kernel"
		rm -f headers.deb image.deb

		#uninstall old t2 kernels but preserve current version as a backup
		for kernel in "${existingK[@]}"
		do
			if [ \( $kernel != linux-image-$currentk \) ]; then
				echo -e "\n$kernel needs to be removed"
				version=${kernel/#linux-image-}
				#purge old t2 kernel
				echo
				dpkg -P linux-headers-$version
				echo
				dpkg -P linux-image-$version
			fi
		done
		if [[ ($1 = --remove-current) || (${currentk_external} = t2-external) ]]; then
			echo -e "\nCurrent kernel linux-image-$currentk shall also be removed"
			echo
			dpkg -P linux-headers-$currentk
			echo
			dpkg -P linux-image-$currentk
		fi
	fi
else
echo "Kernel is up to date"
fi
